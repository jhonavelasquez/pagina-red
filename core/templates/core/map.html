{% extends 'core/base.html' %}

{% block title %} P치gina de Rutas {% endblock %}
{% block head %}
<link rel="stylesheet" href="static\core\css\map1.css" />
{% endblock %}

{% block menu %}
<li class="nav-item">
    <a class="nav-link" aria-current="page" href="{% url 'index' %}">Inicio</a>
  </li>
  <li class="nav-item">
    <a class="nav-link active" aria-current="page" href="{% url 'map_view' %}">Rutas Actuales</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="{% url 'schedule_view' %}">Horarios</a>
</li>
{% endblock %}
{% block content %}
    <!-- Dropdown para filtrar por codsint -->
    
     <div id="rutas">
        <div>
            <h1>Rutas y Paradas</h1>
        </div>
        <form id="select" method="get" action="{% url 'map_view' %}">
            <select id="codsint" name="codsint" class="form-select form-select-sm" aria-label="Small select example">
                <option selected>Selecciona una Ruta</option>
                {% for codsint in codsint_choices %}
                    <option value="{{ codsint }}" {% if codsint == codsint_filter %}selected{% endif %}>{{ codsint }}</option>
                {% endfor %}
              </select>
            <button type="submit">Filtrar</button>
        </form>
     </div>
    <!-- Mapa -->
    <div id="map"></div>
 
    <!-- Script para inicializar el mapa y cargar los datos -->
    <script>
        // Obtener los datos JSON de paraderos desde el contexto de Django
        var paraderos = {{ paraderos_json|safe }};
        var pathIda = {{ path_ida|safe }};
        var pathRegreso = {{ path_regreso|safe }};
        var rutaColor = "{{ ruta_color }}";

        // Inicializar el mapa con Leaflet
        var map = L.map('map').setView([-33.45, -70.65], 13);  // Coordenadas iniciales y nivel de zoom

        // A침adir capa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // A침adir la ruta al mapa
        if (pathIda.length > 0) {
            L.polyline(pathIda, { color: rutaColor }).addTo(map);
        }
        if (pathRegreso.length > 0) {
            L.polyline(pathRegreso, { color: rutaColor }).addTo(map);
        }

        // Iterar sobre los paraderos y a침adir marcadores al mapa
        for (var i = 0; i < paraderos.length; i++) {
            var paradero = paraderos[i];
            var coords = paradero.coords;
            var name = paradero.name;
            var description = paradero.description;
            var color = paradero.color;

            if (coords[0] && coords[1]) {
                var marker = L.circleMarker(coords, {
                    color: color,
                    radius: 5,
                    fillColor: color,
                    fillOpacity: 1
                }).addTo(map);

                marker.bindPopup('<b>' + name + '</b><br>' + description);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

{% endblock %}